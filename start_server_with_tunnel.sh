#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ AI Server —Å Ngrok —Ç—É–Ω–Ω–µ–ª–µ–º"
echo "===================================="

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–º–∞–Ω–¥
check_command() {
    if command -v $1 &> /dev/null; then
        return 0
    else
        echo -e "${RED}‚ùå $1 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞.${NC}"
        return 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–∞–Ω–¥
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
check_command java || exit 1
check_command ngrok || {
    echo -e "${YELLOW}‚ö†Ô∏è  Ngrok –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ:${NC}"
    echo "   ./setup_ngrok.sh"
    exit 1
}

echo -e "${GREEN}‚úÖ –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã${NC}"
echo ""

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π..."
mkdir -p images
echo -e "${GREEN}‚úÖ –ü–∞–ø–∫–∞ images —Å–æ–∑–¥–∞–Ω–∞${NC}"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
start_server() {
    echo -e "${BLUE}üîß –ó–∞–ø—É—Å–∫ AI Code Analysis Server...${NC}"
    echo "   –ü–æ—Ä—Ç: 8080"
    echo "   –õ–æ–∫–∞–ª—å–Ω—ã–π URL: http://localhost:8080"
    echo ""

    # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
    ./gradlew :shared:runWebServer
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ ngrok
start_ngrok() {
    echo -e "${BLUE}üåê –ó–∞–ø—É—Å–∫ Ngrok —Ç—É–Ω–Ω–µ–ª—è...${NC}"
    echo "   –ü–æ—Ä—Ç: 8080"
    echo "   –û–∂–∏–¥–∞–Ω–∏–µ –ø—É–±–ª–∏—á–Ω–æ–≥–æ URL..."
    echo ""

    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    sleep 3

    # –ó–∞–ø—É—Å–∫ ngrok
    ngrok http 8080
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ –∑–∞–ø—É—Å–∫–∞
if [ "$1" = "--server" ]; then
    start_server
elif [ "$1" = "--tunnel" ]; then
    start_ngrok
else
    echo "üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É:"
    echo ""
    echo "–í–∞—Ä–∏–∞–Ω—Ç 1 - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):"
    echo ""
    echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:"
    echo "   ./start_server_with_tunnel.sh --server"
    echo ""
    echo "2. –û—Ç–∫—Ä–æ–π—Ç–µ –≤—Ç–æ—Ä–æ–π —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç—É–Ω–Ω–µ–ª—å:"
    echo "   ./start_server_with_tunnel.sh --tunnel"
    echo ""
    echo "3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS URL –∏–∑ ngrok –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑–≤–Ω–µ"
    echo ""
    echo "–í–∞—Ä–∏–∞–Ω—Ç 2 - –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫:"
    echo ""
    echo "1. –í –ø–µ—Ä–≤–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:"
    echo "   ./gradlew :shared:runWebServer"
    echo ""
    echo "2. –í–æ –≤—Ç–æ—Ä–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:"
    echo "   ngrok http 8080"
    echo ""
    echo "–í–∞—Ä–∏–∞–Ω—Ç 3 - –° –∫–∞—Å—Ç–æ–º–Ω—ã–º —Å—É–±–¥–æ–º–µ–Ω–æ–º:"
    echo "   ngrok http 8080 --subdomain=my-ai-server"
    echo ""
    echo "üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ngrok:"
    echo "   ‚Ä¢ ngrok http 8080 --region=eu     # –ï–≤—Ä–æ–ø–µ–π—Å–∫–∏–π —Ä–µ–≥–∏–æ–Ω"
    echo "   ‚Ä¢ ngrok http 8080 --region=us     # –ê–º–µ—Ä–∏–∫–∞–Ω—Å–∫–∏–π —Ä–µ–≥–∏–æ–Ω"
    echo "   ‚Ä¢ ngrok http 8080 --region=ap     # –ê–∑–∏–∞—Ç—Å–∫–æ-—Ç–∏—Ö–æ–æ–∫–µ–∞–Ω—Å–∫–∏–π"
    echo "   ‚Ä¢ ngrok dashboard                 # –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ngrok"
    echo ""
    echo "üîó –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ HTTPS URL –≤–∏–¥–∞:"
    echo "   https://abc123.ngrok.io"
    echo ""
    echo "üì± –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:"
    echo "   ‚Ä¢ –ì–ª–∞–≤–Ω–∞—è: https://abc123.ngrok.io/"
    echo "   ‚Ä¢ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: https://abc123.ngrok.io/generate"
    echo "   ‚Ä¢ API: https://abc123.ngrok.io/api/health"
    echo ""
fi
