#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞-–º–æ–Ω–∏—Ç–æ—Ä–∞ –≤ Docker
# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ngrok —Ç—É–Ω–Ω–µ–ª—è –ø—É—Ç–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞-–º–æ–Ω–∏—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ ngrok"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ Docker —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∞."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ docker-compose —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
    echo "‚ùå Docker Compose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker Compose."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞..."
if ! curl -s -f http://localhost:8080/api/health > /dev/null 2>&1; then
    echo "‚ö†Ô∏è  –í–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080"
    echo "üí° –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∫–æ–º–∞–Ω–¥–æ–π:"
    echo "   source venv/bin/activate && ./gradlew :shared:runWebServer"
    echo ""
    echo "‚ùì –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∞? (y/N): "
    read -r response
    if [[ ! "$response" =~ ^([yY][eE][sS]|[yY])$ ]]; then
        echo "–û—Ç–º–µ–Ω–∞ –∑–∞–ø—É—Å–∫–∞."
        exit 0
    fi
else
    echo "‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω"
fi

echo ""
echo "üê≥ –ó–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –º–æ–Ω–∏—Ç–æ—Ä–æ–º..."

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
if command -v docker-compose &> /dev/null; then
    docker-compose -f docker-compose.monitor.yml up -d
else
    docker compose -f docker-compose.monitor.yml up -d
fi

if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –°–µ—Ä–≤–∏—Å-–º–æ–Ω–∏—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    echo ""
    echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
    docker ps | grep ai-advent-monitor
    echo ""
    echo "üìù –õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∞:"
    echo "   docker logs -f ai-advent-monitor"
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∞:"
    echo "   docker stop ai-advent-monitor"
    echo ""
    echo "üéØ –ú–æ–Ω–∏—Ç–æ—Ä –±—É–¥–µ—Ç:"
    echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã"
    echo "   ‚Ä¢ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏"
    echo "   ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø—Ä–∏ —Å–±–æ—è—Ö"
else
    echo ""
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞-–º–æ–Ω–∏—Ç–æ—Ä–∞"
    exit 1
fi
