# üóÑÔ∏è –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö AIAdvent

## üìã –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Room –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ AIAdvent –∏ –∫–∞–∫ —Ä–µ—à–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å—Ö–µ–º—ã.

## üö® –ü—Ä–æ–±–ª–µ–º–∞: "Room cannot verify the data integrity"

### **–ü—Ä–∏—á–∏–Ω–∞:**
–û—à–∏–±–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ –º—ã –∏–∑–º–µ–Ω—è–µ–º —Å—Ö–µ–º—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–¥–æ–±–∞–≤–ª—è–µ–º/—É–¥–∞–ª—è–µ–º –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—è—Ö), –Ω–æ –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é.

### **–ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏:**
```
java.lang.IllegalStateException: Room cannot verify the data integrity. 
Looks like you've changed schema but forgot to update the version number. 
You can simply fix this by increasing the version number. 
Expected identity hash: 4748f1463b4693ca3c29e1cb4081ad6c, 
found: e9d2c1f2131352a02fd6717c0c9f90cd
```

## üîß –†–µ—à–µ–Ω–∏–µ

### **1. –û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**

–í —Ñ–∞–π–ª–µ `ChatDatabase.kt`:

```kotlin
@Database(entities = [ChatMessage::class], version = 4, exportSchema = false)
```

### **2. –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é**

```kotlin
// –ú–∏–≥—Ä–∞—Ü–∏—è —Å –≤–µ—Ä—Å–∏–∏ 3 –Ω–∞ –≤–µ—Ä—Å–∏—é 4
private val MIGRATION_3_4 = object : Migration(3, 4) {
    override fun migrate(db: SupportSQLiteDatabase) {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–æ–ª–æ–Ω–∫—É –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –æ —Ç–µ—Å—Ç–∞—Ö
        db.execSQL("ALTER TABLE chat_messages ADD COLUMN isTestReport INTEGER NOT NULL DEFAULT 0")
    }
}
```

### **3. –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ —Å–ø–∏—Å–æ–∫**

```kotlin
.addMigrations(MIGRATION_1_2, MIGRATION_2_3, MIGRATION_3_4)
```

## üìä –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π

### **–í–µ—Ä—Å–∏—è 1 ‚Üí 2:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `isAgent1` –∏ `isAgent2` –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤

### **–í–µ—Ä—Å–∏—è 2 ‚Üí 3:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `isImageGeneration`, `imageUrl`, `imagePrompt` –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### **–í–µ—Ä—Å–∏—è 3 ‚Üí 4:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `isTestReport` –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ –æ —Ç–µ—Å—Ç–∞—Ö

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–æ–∫

### **fallbackToDestructiveMigration()**
```kotlin
.fallbackToDestructiveMigration() // –£–¥–∞–ª—è–µ—Ç –±–∞–∑—É –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π
```

**–í–∞–∂–Ω–æ:** –≠—Ç–∞ –æ–ø—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π, —á—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—è

### **1. –ò–∑–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö**
```kotlin
data class ChatMessage(
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
    val newField: String? = null // –ù–æ–≤–æ–µ –ø–æ–ª–µ
)
```

### **2. –£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Ä—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
```kotlin
@Database(entities = [ChatMessage::class], version = 5, exportSchema = false)
```

### **3. –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é**
```kotlin
private val MIGRATION_4_5 = object : Migration(4, 5) {
    override fun migrate(db: SupportSQLiteDatabase) {
        db.execSQL("ALTER TABLE chat_messages ADD COLUMN newField TEXT")
    }
}
```

### **4. –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –º–∏–≥—Ä–∞—Ü–∏–π**
```kotlin
.addMigrations(MIGRATION_1_2, MIGRATION_2_3, MIGRATION_3_4, MIGRATION_4_5)
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π

### **1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏—é**
```bash
./gradlew compileDebugKotlin
```

### **2. –ó–∞–ø—É—Å—Ç–∏—Ç—å unit —Ç–µ—Å—Ç—ã**
```bash
./gradlew testDebugUnitTest
```

### **3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ/—ç–º—É–ª—è—Ç–æ—Ä
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤—ã–µ –ø–æ–ª—è –¥–æ—Å—Ç—É–ø–Ω—ã

## üö® –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

### **–í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å SQL –≤ –º–∏–≥—Ä–∞—Ü–∏–∏
2. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–µ—Ä—Å–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∞
3. –î–æ–±–∞–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –≤ —Å–ø–∏—Å–æ–∫

### **–í–∞—Ä–∏–∞–Ω—Ç 2: –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ**
1. –£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Ä—Å–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
2. –£–±—Ä–∞—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `fallbackToDestructiveMigration()`

### **–í–∞—Ä–∏–∞–Ω—Ç 3: –°–±—Ä–æ—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
1. –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
2. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –∑–∞–Ω–æ–≤–æ

## üì± –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

### **–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
–í–≤–µ–¥–∏—Ç–µ –≤ —á–∞—Ç–µ: `run tests`

–≠—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç —Ç–µ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≤–µ—Ä—è—Ç —Ä–∞–±–æ—Ç—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π.

## üîç –û—Ç–ª–∞–¥–∫–∞

### **–õ–æ–≥–∏ Room:**
```kotlin
// –í build.gradle.kts
android {
    defaultConfig {
        javaCompileOptions {
            annotationProcessorOptions {
                arguments += [
                    "room.schemaLocation": "$projectDir/schemas".toString(),
                    "room.incremental": "true",
                    "room.expandProjection": "true"
                ]
            }
        }
    }
}
```

### **–ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ö–µ–º—ã:**
```bash
./gradlew exportSchema
```

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Room Migrations](https://developer.android.com/training/data-storage/room/migrating-db-versions)
- [Room Database](https://developer.android.com/training/data-storage/room)
- [SQLite ALTER TABLE](https://www.sqlite.org/lang_altertable.html)

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ–≥–¥–∞:
1. ‚úÖ –£–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –≤–µ—Ä—Å–∏—é
2. ‚úÖ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
3. ‚úÖ –î–æ–±–∞–≤–ª—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –≤ —Å–ø–∏—Å–æ–∫
4. ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
5. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `fallbackToDestructiveMigration()` –¥–ª—è –∑–∞—â–∏—Ç—ã

–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø–∞–¥–µ–Ω–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
